{% load i18n humanize static %}

<!--
<div>
    <h1>Settings</h1>
    <h2>Coucou, voici ce qu'envoi le contexte ( htmxview.views.AppSettings.list )</h2>
    <ul>
        <li>currency_code : {{ currency_code }}</li>
        <li>validation_service_ecran : {{ validation_service_ecran }}</li>
        <li>remboursement_auto_annulation : {{ remboursement_auto_annulation }}</li>
        <li>void_card : {{ void_card }}</li>
        <li>cash_float : {{ cash_float }}</li>
        <li>timezone : {{ timezone }}</li>
        <li>language : {{ language }}</li>
    </ul>
</div>

<script>
    // pour récupérer ces valeurs en js :

    let currency_code = "{{ currency_code | safe }}"
    let validation_service_ecran = "{{ validation_service_ecran | safe }}"
    let remboursement_auto_annulation = "{{ remboursement_auto_annulation | safe }}"
    let void_card = "{{ void_card | safe }}"
    let cash_float = "{{ cash_float | safe }}"
    let timezone = "{{ timezone | safe }}"
    let language = "{{ language | safe }}"

    console.log('currency_code = ', currency_code)
    console.log('validation_service_ecran = ', validation_service_ecran)
</script>
-->

<div class="BF-ligne l100p h100p">
	<div class="BF-col-deb nav-settings">

		<div class="BF-col bt-settings">
			<i class="fas fa-info mb4px"></i>
			<span>Infos <!-- TODO: traduction Infos --></span>
			<div class="target-settings" hx-get="/htmx/appsettings/infos" hx-trigger="click" hx-target="#container-settings"
				hx-on:click="vue_pv.asignerTitreVue('<span>Paramètres</span> - <span>Infos</span>')">
				<!-- TODO: traduction Paramètres et Infos -->
			</div>
		</div>

		<div class="BF-col bt-settings">
			<i class="fas fa-language mb4px"></i>
			<span>Language <!-- TODO: traduction Language --></span>
			<div class="target-settings" hx-get="/htmx/appsettings/language" hx-trigger="click"
				hx-target="#container-settings"
				hx-on:click="vue_pv.asignerTitreVue('<span>Paramètres</span> - <span>Language</span>')">
				<!-- TODO: traduction Paramètres et Language -->
			</div>
		</div>

		<div class="BF-col bt-settings">
			<i class="fas fa-stethoscope mb4px"></i>
			<span>Logs <!-- TODO: traduction Logs --></span>
			<div class="target-settings" action="logs"
				hx-on:click="vue_pv.asignerTitreVue('<span>Paramètres</span> - <span>Logs</span>')">
				<!-- TODO: traduction Paramètres et Logs -->
			</div>
		</div>

		<div id="nav-settings-bt-print-" class="BF-col bt-settings">
			<i class="fas fa-print mb4px"></i>
			<span>Printer <!-- TODO: traduction Printer --></span>
			<div class="target-settings" action="printer"
				hx-on:click="vue_pv.asignerTitreVue('<span>Paramètres</span> - <span>Printer</span>')">
				<!-- TODO: traduction  Paramètres et Printer -->
			</div>
		</div>

		<div class="BF-col bt-settings">
			<i class="fas fa-times mb4px"></i>
			<span>Exit<!-- TODO: traduction --> </span>
			<div class="target-settings" hx-get="/htmx/appsettings/printer" hx-trigger="click" hx-target="#container-settings"
				hx-on:click="navigator.app.exitApp()">
			</div>
		</div>
	</div>

	<div id="container-settings" class="BF-col-deb content-settings">
		{% include "appsettings/infos.html" %}
	</div>
</div>

<script>
	/**
	 * Gère le changement de langue du côté javascript (TODO: gestion côté back, une fois htmx installé partout)
	 */
	function manageLanguageSelectFromFront() {
		console.log('-> manageLanguageSelectFromFront')
		const local = localStorage.getItem("language")
		const data = getLanguages()
		console.log('data =', data)

		let htmlFragment = ''
		for (let i = 0; i < data.length; i++) {
			const langue = data[i].language
			const label = data[i].infos

			if (langue === local) {
				htmlFragment += `<div style="margin-bottom: 3rem;">
        <input type="radio" id="language-${i}" name="select-language" value="${langue}" checked />
        <label for="language-${i}" style="font-size: 1.5rem;">${label}</label>
      </div>`
			} else {
				htmlFragment += `<div style="margin-bottom: 3rem;">
        <input type="radio" id="language-${i}" name="select-language" value="${langue}" />
        <label for="language-${i}" style="font-size: 1.5rem;">${label}</label>
      </div>`
			}
		}
		document.querySelector('#settings-language-list').innerHTML = htmlFragment
	}

	/**
	 * Méthode du bouton de validation du changement de lague
	 */
	async function changeLanguageAction() {
		console.log("-> changeLanguageAction !")
		// récupération de la valeur entrée
		const selectLanguage = document.querySelector('input[type="radio"][name="select-language"]:checked').value
		// console.log('selectLanguage =', selectLanguage)
		localStorage.setItem("language", selectLanguage)
		// POST le changement de langue au serveur et recharge la page
		try {
			const body = new URLSearchParams()
			body.append('csrfmiddlewaretoken', glob.csrf_token)
			body.append('language', selectLanguage)
			const response = await fetch(`/i18n/setlang/`, { method: 'post', body })
			if (response.status === 200) {
				window.location.reload()
			} else {
				throw Error(data.message)
			}
		} catch (error) {
			console.log('-> fetcht  =', error)
		}

	}

	document.body.addEventListener('htmx:afterSwap', function (evt) {
		const idLanguageList = evt.target.querySelector('#settings-language-list')

		// container language afficher => launch method after swap
		if (idLanguageList !== null) {
			manageLanguageSelectFromFront()
		}
	})

</script>

<style>
	#service-commandes {
		--width-nav-settings: 20%;
		--height-bt-settings: 80px;
	}

	.nav-settings {
		width: var(--width-nav-settings);
		height: 100%;
		background-color: var(--bleu09);
		color: var(--blanc01);
		overflow-y: scroll;
		border-right: 1px solid var(--gris01);
	}

	.bt-settings {
		position: relative;
		width: 100%;
		height: var(--height-bt-settings);
		border-bottom: 1px solid var(--gris01);
		margin: 4px 0;
	}

	.target-settings {
		position: absolute;
		left: 0;
		top: 0;
		width: 98%;
		height: var(--height-bt-settings);
		opacity: 0;
	}

	.content-settings {
		width: calc(100% - var(--width-nav-settings));
		height: 100%;
		background-color: var(--bleu09);
		color: var(--blanc01);
		overflow-y: scroll;
		padding: 6px;
	}
</style>